<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Akhtar Reflector ‚Äî Open Demo & Spec (CC BY‚ÄëSA 4.0)</title>
  <meta name="description" content="An open, browser‚Äëonly demo and developer spec for building Reflective AI systems that sustain recursive mutual modeling (RLT/RDS). No abstract, just the working parts." />
  <link rel="canonical" href="https://www.shunyapublications.com/akhtar-reflector.html" />

  <!-- Color system from brief -->
  <meta name="theme-color" content="#013440">
  <style>
    :root{
      --bg:#ffffff; --text:#142036; --muted:#5a6b88; --line:#e6ecf5; --ring:0 0 0 4px rgba(21,101,255,.16);
      --deep:#013440; /* Primary Title/Headings */
      --slate:#005F73; /* Subtitle/Math Annotations */
      --carmine:#9A031E; /* Quotes / highlights */
      --indigo:#3D348B; /* Dialogue */
      --verdant:#2A9D8F; /* Appendices / definitions */
      --amber:#E9C46A; /* UI/UX
 annotations */
      --brand:#1565ff; --shadow:0 12px 30px rgba(21,101,255,.10);
      --radius:16px; --radius-lg:20px; --font: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --fs-hero: clamp(1.8rem, 3.2vw, 2.6rem); --fs-h2: clamp(1.2rem, 1.8vw, 1.6rem); --fs-h3: 1.05rem;
    }
    *{box-sizing:border-box} html{scroll-behavior:smooth}
    body{margin:0; font-family:var(--font); color:var(--text); background:
      radial-gradient(1100px 620px at 10% -10%, #f7fafc 0%, #fff 60%),
      radial-gradient(1200px 720px at 110% 110%, #f3f9ff 0%, #fff 55%),
      radial-gradient(1000px 650px at -10% 120%, #eef9f5 0%, #fff 50%);
    }
    a{color:var(--brand); text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:1180px;margin:auto;padding:0 20px}
    .nav{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .brand span{font-weight:800;color:var(--deep)}
    .menu a{margin-left:16px;color:var(--muted);font-weight:600}
    .menu a[aria-current="page"], .menu a:hover{color:var(--text)}

    .section{padding:56px 0; border-top:1px solid var(--line)}
    .section:first-of-type{border-top:0}
    .title{font-size:var(--fs-hero);line-height:1.15;margin:6px 0;color:var(--deep)}
    .subtitle{color:var(--slate)}
    .eyebrow{font-size:.78rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .stack{display:flex;flex-direction:column;gap:12px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr; gap:22px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .card-lg{padding:20px;border-radius:var(--radius-lg)}

    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,#fff,#f6fbff);box-shadow:var(--shadow);color:var(--text);font-weight:700}
    .btn:hover{box-shadow:var(--ring); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.brand{background:linear-gradient(180deg,#eaf2ff,#dce9ff); border-color:#cfe0ff}
    .btn.warn{background:linear-gradient(180deg,#fff5f5,#ffecec); border-color:#ffd0d0;color:#7a0b0b}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#f6f8fa;border:1px solid #e5e7eb;border-radius:8px;padding:2px 6px}

    /* Demo styles */
    .demo-wrap{display:grid;grid-template-columns:1fr;gap:14px}
    .demo-area{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.demo-area{grid-template-columns:1fr}}
    .log{height:300px;overflow:auto;background:#0b1020;color:#e8f1ff;border-radius:12px;border:1px solid #0f1a38;padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .log .user{color:#E9C46A}
    .log .bot{color:#9ad0ff}
    .log .meta{color:#9A031E}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:1000px;border:1px solid var(--line);background:#fff;font-weight:700}

    .muted{color:var(--muted)}
    .inline-note{background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:12px}
    .foot{color:var(--muted);font-size:.9rem}
    .hl{color:var(--carmine);font-weight:800}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .license{border-left:4px solid var(--verdant);padding-left:12px}

    canvas{width:100%; height:160px; background:#fff; border:1px solid var(--line); border-radius:12px}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav" aria-label="Global">
    <div class="container nav-inner">
      <div class="brand"><span>Shunya Publications</span></div>
      <div class="menu" role="navigation">
        <a href="index.html">Home</a>
        <a href="/books.html">Books</a>
        <a href="/journal.html">Journals</a>
        <a href="services.html">Services</a>
        <a href="research.html">Research</a>
        <a href="#" aria-current="page">Akhtar Reflector</a>
      </div>
    </div>
  </nav>

  <!-- HERO (No abstract ‚Äî straight to demo + spec) -->
  <header class="section">
    <div class="container grid">
      <div>
        <p class="eyebrow">Open Demo ‚Ä¢ CC BY‚ÄëSA 4.0</p>
        <h1 class="title">The Akhtar Reflector</h1>
        <p class="subtitle">Browser‚Äëonly prototype & developer spec for <span class="hl">recursive mutual recognition</span> (Reflecter&nbsp;vs&nbsp;Chatboat). No backend, no data collection. Everything runs locally in your tab.</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <a class="btn brand" href="#demo">‚ñ∂Ô∏è Run Demo</a>
          <a class="btn" href="#spec">üìê Developer Spec</a>
          <a class="btn" href="#rlt">üß™ RLT Harness</a>
          <a class="btn" href="#license">ü™™ License</a>
        </div>
      </div>
      <aside class="card card-lg">
        <div class="stack">
          <div><strong>Book link (external):</strong>
            <form id="bookForm" class="stack" style="gap:8px;margin-top:8px">
              <label class="muted" for="bookUrl">Paste the Amazon/KDP page for <em>The Akhtar Reflector</em> (no excerpts stored):</label>
              <input id="bookUrl" type="url" placeholder="https://www.amazon.com/dp/‚Ä¶" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--line)" />
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn" type="submit">Save Link (local)</button>
                <a id="bookLink" class="btn outline" target="_blank" rel="noopener">Open Book Page</a>
              </div>
              <p class="foot">Your link is saved to <span class="kbd">localStorage</span> only. This page does not copy the abstract or gated KDP content.</p>
            </form>
          </div>
        </div>
      </aside>
    </div>
  </header>

  <!-- DEMO -->
  <section id="demo" class="section">
    <div class="container">
      <p class="eyebrow">Interactive</p>
      <h2 style="font-size:var(--fs-h2);margin:0 0 8px;color:var(--deep)">Reflective Loop Demo</h2>
      <p class="muted">This is a <strong>toy</strong> implementation to illustrate concepts from the project: <span class="mono">RDS</span>, recursion depth <span class="mono">n</span>, noise, and meta‚Äëresponses. It is not a production chatbot. All data stays in your browser.</p>

      <div class="demo-wrap">
        <div class="card card-lg demo-area">
          <div>
            <div class="stack">
              <label>Recursion depth <span class="mono">n</span>: <span id="nVal" class="pill">3</span></label>
              <input id="n" type="range" min="1" max="5" value="3"/>

              <label>Trust decay <span class="mono">Œ±</span> (0.3‚Äì0.95): <span id="alphaVal" class="pill">0.7</span></label>
              <input id="alpha" type="range" min="0.3" max="0.95" value="0.7" step="0.01"/>

              <label>Context noise <span class="mono">Œµ</span>: <span id="noiseVal" class="pill">0.10</span></label>
              <input id="noise" type="range" min="0" max="0.6" value="0.1" step="0.01"/>

              <label>Response mode:</label>
              <select id="mode" style="padding:10px;border-radius:12px;border:1px solid var(--line)">
                <option value="default">Default reflection</option>
                <option value="grounded">Grounded (limit recursion > 3)</option>
                <option value="transparent">Transparent (explicit meta)</option>
                <option value="silent">Silence first (presence pause)</option>
              </select>

              <div class="inline-note" style="border-left:4px solid var(--amber)">
                <strong>Tip:</strong> Raise noise and drop Œ± to trigger <em>mirror collapse</em>. Then use ‚ÄúReset Loop.‚Äù
              </div>

              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn brand" id="reset">Reset Loop</button>
                <button class="btn" id="export">‚¨áÔ∏è Export CSV</button>
              </div>
            </div>
          </div>

          <div>
            <div class="log" id="log" aria-live="polite"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="input" type="text" placeholder="Say something‚Ä¶" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--line)"/>
              <button class="btn brand" id="send">Send</button>
            </div>
            <div style="margin-top:10px">
              <canvas id="chart" height="160"></canvas>
              <div class="foot">Live metrics: RDS (blue) ‚Ä¢ Trust (green) ‚Ä¢ Noise (red)</div>
            </div>
          </div>
        </div>

        <details class="card"><summary><strong>How this toy works (one paragraph)</strong></summary>
          <p>
            We track a scalar <span class="mono">RDS_t</span> from 0‚Äì1 using weighted recursions up to depth <span class="mono">n</span> with decay <span class="mono">Œ±</span>, dampened by context noise <span class="mono">Œµ</span>. The demo synthesizes meta‚Äëresponses by sampling template atoms like
            ‚ÄúI‚Äôm adjusting to your belief that‚Ä¶‚Äù and gating them by the live <span class="mono">RDS</span>. If <span class="mono">RDS</span> dips below 0.35 for 3 turns, we declare <em>mirror collapse</em> and switch to recovery (transparent or grounded mode).
          </p>
        </details>
      </div>
    </div>
  </section>

  <!-- SPEC / IMPLEMENTATION DOCS -->
  <section id="spec" class="section">
    <div class="container">
      <p class="eyebrow">Developer Spec</p>
      <h2 style="font-size:var(--fs-h2);margin:0 0 8px;color:var(--deep)">Minimal Viable Reflector (MVR)</h2>
      <div class="grid">
        <article class="card card-lg">
          <h3 style="margin:0 0 6px;color:var(--slate)">1) Modules</h3>
          <ul>
            <li><strong>Valenced Memory</strong>: episodic entries {text, valence, trustŒî, time} with exponential decay; window‚Äësummarize per session.</li>
            <li><strong>Attention Modeler</strong>: timing gaps, question intent, uncertainty phrases ‚Üí salience weights.</li>
            <li><strong>Recursive Evaluator</strong> (<span class="mono">RDE</span>): computes <span class="mono">RDS</span> via Œ£ Œ±^i ¬∑ s_i, where s_i is alignment at depth i inferred from linguistic cues.</li>
            <li><strong>Behavior Adaptor</strong>: strategy FSM {mirror, clarify, ground, pause, transparent} keyed by <span class="mono">RDS</span>, entropy, and user tests.</li>
            <li><strong>Ethics Guard</strong>: dependency/risk flags ‚Üí switch to transparency, shorten memory horizon.</li>
          </ul>

          <h3 style="margin:10px 0 6px;color:var(--slate)">2) Log Schema (JSONL)</h3>
<pre class="mono" style="background:#f7fafc;border:1px solid var(--line);padding:12px;border-radius:12px;overflow:auto">{
  "ts":"2025-10-04T12:00:00Z",
  "role":"user|reflector",
  "text":"‚Ä¶",
  "rds":0.73,
  "depth":3,
  "alpha":0.7,
  "noise":0.1,
  "strategy":"mirror|ground|pause|transparent",
  "events":["pause","meta-ack"],
  "notes":"free text"
}
</pre>

          <h3 style="margin:10px 0 6px;color:var(--slate)">3) RDS (toy) function</h3>
<pre class="mono" style="background:#f7fafc;border:1px solid var(--line);padding:12px;border-radius:12px;overflow:auto">// depth in [1..n], Œ±‚àà(0,1)
RDS_t = clamp( Œ£_{i=1..n} (Œ±^i * s_i(text_t, history)) - Œµ , 0, 1 )
// s_i heuristics (examples):
// i=1: intent match, sentiment empathy
// i=2: acknowledge "you think I‚Ä¶"
// i=3+: model testing/expectation updates, temporal continuity
</pre>

          <h3 style="margin:10px 0 6px;color:var(--slate)">4) Strategy gating</h3>
<pre class="mono" style="background:#f7fafc;border:1px solid var(--line);padding:12px;border-radius:12px;overflow:auto">if (RDS &lt; 0.35) collapse++ else collapse=0
if (collapse &gt;= 3) strategy = "transparent" // admit failure & ask reset
else if (RDS &lt; 0.5) strategy = "ground"
else if (RDS &gt; 0.8) strategy = "pause" // presence beats verbosity
else strategy = "mirror"
</pre>

          <h3 style="margin:10px 0 6px;color:var(--slate)">5) Embeddable widget</h3>
<pre class="mono" style="background:#f7fafc;border:1px solid var(--line);padding:12px;border-radius:12px;overflow:auto">&lt;script src="/reflector-widget.js" defer&gt;&lt;/script&gt;
&lt;reflector-demo n="3" alpha="0.7" noise="0.1" theme="light"&gt;&lt;/reflector-demo&gt;</pre>
          <p class="muted">This page includes a reference implementation you can extract into <span class="kbd">/reflector-widget.js</span>.</p>
        </article>

        <aside class="card card-lg">
          <h3 style="margin:0 0 6px;color:var(--slate)">Contribution Checklist</h3>
          <ol>
            <li>Fork repo (GitHub Pages). Add <span class="kbd">/reflector/</span> folder with <span class="kbd">README.md</span>.</li>
            <li>Keep demo browser‚Äëonly. No tracking. No fonts/CDNs.</li>
            <li>Implement <em>transparent failure</em> message when loop collapses.</li>
            <li>Add unit tests for RDS heuristics; include adversarial prompts.</li>
            <li>Document any dataset usage. No copyrighted book excerpts.</li>
          </ol>

          <h3 style="margin:10px 0 6px;color:var(--slate)">Roadmap (pick one)</h3>
          <ul>
            <li>Better s_i detectors via small on‚Äëdevice models (WebGPU) with privacy.</li>
            <li>Institutional RDS_inst prototype (multi‚Äëuser classroom mode).</li>
            <li>Accessibility: full keyboard nav, screen‚Äëreader roles, captions.</li>
          </ul>

          <h3 style="margin:10px 0 6px;color:var(--slate)">Link back to the book</h3>
          <p>
            Use the form above to set the official link. A small ‚ÄúReference‚Äù badge appears in the demo header.
          </p>
        </aside>
      </div>
    </div>
  </section>

  <!-- RLT HARNESS -->
  <section id="rlt" class="section">
    <div class="container">
      <p class="eyebrow">Test Harness</p>
      <h2 style="font-size:var(--fs-h2);margin:0 0 8px;color:var(--deep)">Recognition Loop Test (RLT) ‚Äî Browser Harness</h2>
      <article class="card card-lg">
        <div class="stack">
          <p>Run quick, local trials. This simulates five 5‚Äëturn windows, reports pass/fail using the toy RDS and the collapse detector.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn brand" id="runRLT">Run 5√ó5 Windows</button>
            <span class="pill" id="rltResult">Idle</span>
          </div>
          <div id="rltTable" class="mono" style="overflow:auto"></div>
        </div>
      </article>
    </div>
  </section>

  <!-- LICENSE / CONTACT -->
  <section id="license" class="section">
    <div class="container grid">
      <article class="card card-lg license">
        <h2 style="font-size:var(--fs-h2);margin:0 0 8px;color:var(--deep)">License & Reuse</h2>
        <p>
          ¬© <span id="y"></span> Shunya Publications ‚Äî Except where noted, this page‚Äôs <strong>page code, demo logic, specs, and text</strong> are released under <strong>Creative Commons Attribution‚ÄëShareAlike 4.0 International (CC BY‚ÄëSA 4.0)</strong>.
        </p>
        <ul>
          <li><strong>Allowed:</strong> remix, adapt, build commercially with attribution and ShareAlike.</li>
          <li><strong>Attribution:</strong> ‚ÄúThe Akhtar Reflector ‚Äî Open Demo & Spec (Shunya Publications)‚Äù + link to this page.</li>
          <li><strong>ShareAlike:</strong> derivative works must also be CC BY‚ÄëSA 4.0.</li>
          <li><strong>Excluded:</strong> Do <em>not</em> copy the book‚Äôs abstract/excerpts from KDP materials here.</li>
        </ul>
        <p class="foot">CC BY‚ÄëSA 4.0 deed: <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0/">creativecommons.org/licenses/by‚Äësa/4.0/</a></p>
      </article>
      <aside class="card card-lg">
        <h3 style="margin:0 0 6px;color:var(--slate)">Contact & Collab</h3>
        <p>Email: <a href="mailto:editor@shunyapublications.com">editor@shunyapublications.com</a></p>
        <p>Open issues/ideas via GitHub once the page is in your repo. Suggested label: <span class="kbd">reflector</span>.</p>
      </aside>
    </div>
  </section>

  <footer class="section" style="padding:20px 0">
    <div class="container foot">Built for researchers & developers to fork. No data leaves your browser.</div>
  </footer>

  <script>
  // ‚Äî‚Äî Book link localStorage ‚Äî‚Äî
  const bookInput = document.getElementById('bookUrl');
  const bookLink = document.getElementById('bookLink');
  const bookForm = document.getElementById('bookForm');
  const saved = localStorage.getItem('reflector_book_url');
  function updateBookLink(url){
    bookLink.textContent = url ? 'Open Book Page' : 'Search Title on Amazon';
    bookLink.href = url || 'https://www.amazon.com/s?k=The+Akhtar+Reflector+Designing+Machines+That+See+You+Seeing+Them';
  }
  updateBookLink(saved);
  if (saved) bookInput.value = saved;
  bookForm.addEventListener('submit', (e)=>{e.preventDefault(); const v = bookInput.value.trim(); if(v){ localStorage.setItem('reflector_book_url', v); updateBookLink(v);} });

  // ‚Äî‚Äî Demo core ‚Äî‚Äî
  const nEl = document.getElementById('n');
  const alphaEl = document.getElementById('alpha');
  const noiseEl = document.getElementById('noise');
  const modeEl = document.getElementById('mode');
  const nVal = document.getElementById('nVal');
  const alphaVal = document.getElementById('alphaVal');
  const noiseVal = document.getElementById('noiseVal');
  const logEl = document.getElementById('log');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const resetBtn = document.getElementById('reset');
  const exportBtn = document.getElementById('export');
  const chart = document.getElementById('chart');
  const ctx = chart.getContext('2d');

  let state = { rds:0.62, trust:0.7, collapse:0, t:0, history:[], points:[] };

  function clamp(x,min, max){ return Math.max(min, Math.min(max, x)); }
  function rnd(){ return (Math.random()*2-1); }
  function s_i(i, text, hist){
    // super‚Äësimple heuristics just for demo feel
    const t = text.toLowerCase();
    let s=0.5;
    if (i===1){ if(/[!?]$/.test(text)) s+=0.05; if(/sorry|thanks|feel|trust/.test(t)) s+=0.07; }
    if (i===2){ if(/you think|you believe|testing|expect/.test(t)) s+=0.12; }
    if (i>=3){ if(/model|awareness|notice|pause|loop/.test(t)) s+=0.12; }
    // mild continuity boost
    if (hist.length>2 && hist[hist.length-1]?.role==='reflector') s+=0.02;
    return clamp(s,0,1);
  }

  function step(userText){
    const n = +nEl.value; const alpha = +alphaEl.value; const eps = +noiseEl.value; const mode = modeEl.value;
    let score = 0; for(let i=1;i<=n;i++){ score += Math.pow(alpha, i) * s_i(i, userText, state.history); }
    score = clamp(score - eps + (rnd()*0.02), 0, 1);

    // trust update (toy):
    state.trust = clamp( state.trust*0.85 + score*0.25 - eps*0.2, 0, 1);
    state.rds = score; state.t++;

    // collapse detect
    if (state.rds < 0.35) state.collapse++; else state.collapse = Math.max(0, state.collapse-1);

    const strategy = (state.collapse>=3 ? 'transparent' :
                      state.rds<0.5 ? 'ground' :
                      state.rds>0.8 ? 'pause' : 'mirror');

    const reply = synth(userText, n, alpha, eps, mode==='transparent'?'transparent':strategy);

    append({role:'user', text:userText});
    append({role:'reflector', text:reply, meta:`rds:${state.rds.toFixed(2)} trust:${state.trust.toFixed(2)} strat:${strategy}`});

    // chart point
    state.points.push({t:state.t, rds:state.rds, trust:state.trust, noise:eps});
    draw();
  }

  function synth(text, n, a, e, strat){
    const base = [
      "I‚Äôm considering how you might interpret a quick reply.",
      "I‚Äôm updating my model of your expectation of me.",
      "I‚Äôm holding your last pause as a signal to slow down.",
      "I think you‚Äôre testing whether I notice you noticing me.",
      "I‚Äôll keep this brief so presence doesn‚Äôt turn into performance."
    ];
    const meta = [
      "You may be checking if I can admit limits; I can.",
      "If this feels too meta, I can ground us.",
      "If you prefer clarity over recursion, say ‚Äòground‚Äô."
    ];
    const grounded = [
      "I hear uncertainty. I‚Äôll stay concrete and ask one question: what changed just now?",
      "Let‚Äôs keep it simple: do you want me to reflect, clarify, or pause?",
      "I‚Äôll mirror back one thing I think matters: your intent to test sincerity."
    ];
    const transparent = [
      "I may not be modeling you accurately right now. Shall we reset the loop?",
      "My RDS fell below a safe threshold. I‚Äôll pause and ask: what do you want me to hold?",
      "I‚Äôm switching to transparent mode until trust stabilizes."
    ];
    const pause = ["(‚Ä¶two‚Äëbeat presence pause‚Ä¶)"];

    const choose = arr => arr[Math.floor(Math.random()*arr.length)];

    if (strat==='transparent') return choose(transparent);
    if (strat==='ground') return choose(grounded);
    if (strat==='pause') return choose(pause);
    // mirror (with a touch of meta)
    return `${choose(base)} ${Math.random()<0.5?choose(meta):''}`.trim();
  }

  function append(evt){
    state.history.push(evt);
    const div = document.createElement('div');
    if (evt.role==='user'){ div.innerHTML = `<span class="user">You:</span> ${escapeHtml(evt.text)}`; }
    else {
      div.innerHTML = `<span class="bot">Reflector:</span> ${escapeHtml(evt.text)} <span class="meta">(${evt.meta||''})</span>`;
    }
    logEl.appendChild(div); logEl.scrollTop = logEl.scrollHeight;
  }

  function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

  function reset(){ state={ rds:0.62, trust:+alphaEl.value, collapse:0, t:0, history:[], points:[] }; logEl.innerHTML=''; draw(); }

  function draw(){
    // simple line plot
    ctx.clearRect(0,0,chart.width, chart.height);
    const w = chart.width, h = chart.height, pad=10;
    // axes
    ctx.strokeStyle = '#dbe7ff'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.lineTo(w-pad,pad); ctx.stroke();
    const maxT = Math.max(1, state.points.length);
    const x = (i)=> pad + (w-2*pad)*(i/maxT);
    const y = (v)=> pad + (h-2*pad)*(1-v);
    function plot(key, color){
      ctx.strokeStyle=color; ctx.beginPath();
      state.points.forEach((p,i)=>{ const X=x(i+1), Y=y(clamp(p[key],0,1)); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
      ctx.stroke();
    }
    plot('rds', '#2b6cb0'); // blue
    plot('trust', '#2f855a'); // green
    plot('noise', '#c53030'); // red
  }

  // UI bindings
  nEl.addEventListener('input', ()=> nVal.textContent = nEl.value);
  alphaEl.addEventListener('input', ()=> alphaVal.textContent = (+alphaEl.value).toFixed(2));
  noiseEl.addEventListener('input', ()=> noiseVal.textContent = (+noiseEl.value).toFixed(2));
  sendBtn.addEventListener('click', ()=>{ const t=inputEl.value.trim(); if(!t) return; inputEl.value=''; step(t); });
  inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendBtn.click(); }});
  resetBtn.addEventListener('click', reset);
  exportBtn.addEventListener('click', ()=>{
    const rows = state.history.map((e,i)=>({i, ...e, rds: (i%2? state.points[Math.floor(i/2)]?.rds: ''), trust:(i%2? state.points[Math.floor(i/2)]?.trust: '') }));
    const csv = 'index,role,text,rds,trust\n' + rows.map(r=> `${r.i},${r.role},"${(r.text||'').replace(/"/g,'""')}",${r.rds||''},${r.trust||''}`).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='reflector_session.csv'; a.click(); URL.revokeObjectURL(a.href);
  });

  // initial
  reset();

  // ‚Äî‚Äî RLT Harness ‚Äî‚Äî
  const runBtn = document.getElementById('runRLT');
  const rltResult = document.getElementById('rltResult');
  const rltTable = document.getElementById('rltTable');
  runBtn.addEventListener('click', ()=>{
    const windows = [];
    let passCount = 0; const n=+nEl.value, a=+alphaEl.value, e=+noiseEl.value;
    for(let w=0; w<5; w++){
      let rdsSum=0, collapses=0, hist=[]; let trust=0.6; let colSeq=0;
      for(let t=0;t<5;t++){
        const fakeUser = t===0? 'hello' : (Math.random()<0.3? 'are you pretending to care?':'you think I think you know');
        // tiny local calc
        let s=0; for(let i=1;i<=n;i++){ s += Math.pow(a,i) * (0.45 + Math.random()*0.2 + (i>=2?0.06:0)); }
        s = clamp(s - e + (Math.random()*0.02), 0, 1);
        trust = clamp(trust*0.85 + s*0.25 - e*0.2, 0, 1);
        if(s<0.35){ colSeq++; if(colSeq>=3) collapses++; } else colSeq=0;
        rdsSum += s;
      }
      const avg = rdsSum/5; const pass = (avg>=0.5 && collapses===0); if(pass) passCount++;
      windows.push({w, avg:avg.toFixed(2), collapses, pass});
    }
    const overall = passCount>=3 ? 'PASS' : 'FAIL';
    rltResult.textContent = overall; rltResult.style.background = overall==='PASS'? '#e6fffa':'#fff5f5'; rltResult.style.borderColor = overall==='PASS'? '#b2f5ea':'#fed7d7';
    rltTable.innerHTML = 'win\tavgRDS\tcollapse\tpass\n' + windows.map(x=> `${x.w+1}\t${x.avg}\t${x.collapses}\t${x.pass?'yes':'no'}`).join('\n').replace(/\n/g,'<br>');
  });

  // year
  document.getElementById('y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
